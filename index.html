<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">

  <title>PHP基礎</title>

  </head>
  <body>

    <h1>投稿一覧</h1>
    <?php
        //投稿された内容の一覧を表示させる

        //thanks.phpに書いてあるものをコピペし、持ってくる
        //データベースに接続するための大事な文章
        $db = mysqli_connect('localhost', 'root', 'root', 'php_test') or die(mysqli_connect_error());
        mysqli_set_charset($db, 'utf8');
        //------------------------------
        // posts　から 1(全部)を取ってくる
        //これがクエリ

        //WHERE del_flg=0 論理削除
        $sql = 'SELECT * FROM posts WHERE del_flg=0';
        //データベースを使用する際に必要なこと
        //mysqli_queryに($db, $sql)が入っている
        //mysqli_query($db, $sql) or die(mysqli_error($db));

        // if(isset($_REQUEST['id'])){
        // $sql = sprintf('SELECT m.name, p.* FROM posts  p WHERE m.id=p.id AND p.id=%d ORDER BY p.created DESC',
        //     mysqli_real_escape_string($db,$_REQUEST['id']));
        // $record = mysqli_query($db,$sql) or die(mysqli_error($db));
        // $table = mysqli_fetch_array($record);
        // $comment = $table['comment'];
        // }

        // //更新している
        // if(!empty($_POST)){
        //     if($_POST['comment'] != ''){
        //         $sql = sprintf('UPDATE posts SET comment="%s" WHERE id=%d',
        //             mysqli_real_escape_string($db,$_POST['comment']),
        //             mysqli_real_escape_string($db,$_GET['id']));

        //             mysqli_query($db,$sql) or die(mysqli_error($db));

                    //これすることによって再読込ボタンを押したことによる、二重投稿を防止している。
                    header('Location:ichiran.php');
            exit();
    }
}
        
        //mysqli_query($db, $sql) or die(mysqli_error($db));

        //mysqli_queryデータベースにCRUD処理を与える
        if ($result = mysqli_query($db, $sql)) {

            /* 連想配列を取得します */
            while ($row = mysqli_fetch_assoc($result)) {
                print $row['id'];
                print $row['name'];
                print $row['message'];
                print sprintf('<a href="delete.php?id=%d">削除</a>',$row['id']);
                print '</br>';
            }

            /* 結果セットを開放します */
            mysqli_free_result($result);
        }
    ?>
    </br>
    <a href="index.php">メニューに戻る</a></br>
  </body>
</html>